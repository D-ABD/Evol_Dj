{% extends 'base.html' %}
{% block title %}Dashboard - MyEvol{% endblock %}
{% block content %}

<!-- Toasts Bootstrap pour les nouvelles notifications -->
{% if notifications %}
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    {% for notif in notifications %}
      <div class="toast show mb-2" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-white">
          <strong class="me-auto">üéâ Notification</strong>
          <small>Maintenant</small>
          <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast" aria-label="Fermer"></button>
        </div>
        <div class="toast-body">
          {{ notif.message }}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="alert alert-success text-center mt-3">
    Tu viens de d√©bloquer un nouveau badge ! üèÖ F√©licitations üéâ
  </div>
{% endif %}

<h2 class="fw-bold mb-4">Tableau de bord</h2>

<!-- Statistiques g√©n√©rales -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card border-primary">
      <div class="card-body">
        <h5 class="card-title">Nombre d'entr√©es</h5>
        <p class="display-6">{{ total_entries }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-success">
      <div class="card-body">
        <h5 class="card-title">Humeur moyenne</h5>
        <p class="display-6">{{ avg_mood }}/10</p>
      </div>
    </div>
  </div>
</div>

<!-- Graphique humeur 7 jours -->
<h4 class="mt-5">üìä Humeur sur les 7 derniers jours</h4>
<canvas id="moodChart" height="100"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  fetch("{% url 'myevol:weekly_mood_chart' %}")
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('moodChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Humeur moyenne',
            data: data.data,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              max: 10
            }
          }
        }
      });
    });
</script>

<!-- Objectifs atteints par mois -->
<h4 class="mt-5">üìÜ Objectifs atteints par mois</h4>
<canvas id="objectivesChart" height="100"></canvas>
<script>
  fetch("{% url 'myevol:monthly_objectives_chart' %}")
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('objectivesChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Objectifs atteints',
            data: data.data,
            backgroundColor: 'rgba(75, 192, 192, 0.5)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              precision: 0
            }
          }
        }
      });
    });
</script>

<!-- Camembert par cat√©gorie -->
<h4 class="mt-5">ü•ß R√©partition des objectifs atteints par cat√©gorie</h4>
<canvas id="categoryPieChart" height="100"></canvas>
<script>
  fetch("{% url 'myevol:objectives_by_category_chart' %}")
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('categoryPieChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Objectifs',
            data: data.data,
            backgroundColor: [
              '#6f42c1', '#198754', '#0d6efd', '#fd7e14', '#dc3545', '#20c997'
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    });
</script>

<!-- Timeline -->
<h4 class="mt-5">üìä √âvolution humeur & objectifs sur 30 jours</h4>
<canvas id="timelineChart" height="120"></canvas>
<script>
  fetch("{% url 'myevol:mood_objectives_chart' %}")
    .then(res => res.json())
    .then(data => {
      const ctx = document.getElementById('timelineChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            {
              type: 'line',
              label: 'Humeur moyenne',
              data: data.moods,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'transparent',
              tension: 0.4
            },
            {
              type: 'bar',
              label: 'Objectifs atteints',
              data: data.objectives,
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              precision: 0
            }
          }
        }
      });
    });
</script>

<!-- Niveau et progression -->
<h4 class="mt-4">üèÜ Niveau {{ progression.level }}</h4>
<div class="progress mb-2" style="height: 25px;">
  <div class="progress-bar bg-info" role="progressbar"
       style="width: {{ progression.progress }}%;"
       aria-valuenow="{{ progression.progress }}" aria-valuemin="0" aria-valuemax="100">
    {{ progression.progress }}%
  </div>
</div>
<small>Objectif : {{ progression.entries }}/{{ progression.next_threshold }} entr√©es</small>

<!-- Objectifs -->
<h4 class="mt-4">üéØ Tes objectifs</h4>
{% if objectives %}
  {% for obj in objectives %}
    <div class="card mb-2">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <strong>{{ obj.title }}</strong><br>
            <small class="text-muted">Cat√©gorie : {{ obj.category }}</small>
          </div>
          <div>
            {% if obj.done %}
              <span class="badge bg-success">Termin√©</span>
            {% else %}
              <span class="badge bg-warning text-dark">En cours</span>
            {% endif %}
          </div>
        </div>
        <small>Pour le {{ obj.target_date|date:"d/m/Y" }}</small>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">Aucun objectif trouv√©.</p>
{% endif %}

<!-- Statistiques par cat√©gorie -->
<h4 class="mt-4">üìö Cat√©gories populaires</h4>
<ul class="list-group mb-4">
  {% for stat in categories_stats %}
    <li class="list-group-item d-flex justify-content-between">
      <span>{{ stat.category }}</span>
      <span class="badge bg-primary rounded-pill">{{ stat.count }}</span>
    </li>
  {% empty %}
    <li class="list-group-item text-muted">Aucune cat√©gorie enregistr√©e.</li>
  {% endfor %}
</ul>

<!-- Derni√®res entr√©es -->
<h4 class="mt-4">üìî Derni√®res entr√©es</h4>
{% if entries %}
  {% for entry in entries %}
    <div class="card mb-2">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <p class="mb-1">{{ entry.content }}</p>
            <small class="text-muted">
              Cat√©gorie : {{ entry.category }} | Humeur : {{ entry.mood }}/10 | {{ entry.created_at|date:"d/m/Y" }}
            </small>
          </div>
          <div>
            <a href="{% url 'myevol:edit_entry' entry.id %}" class="btn btn-sm btn-outline-primary">Modifier</a>
            <a href="{% url 'myevol:delete_entry' entry.id %}" class="btn btn-sm btn-outline-danger">Supprimer</a>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">Aucune entr√©e pour le moment.</p>
{% endif %}

<!-- Badges -->
<h4 class="mt-5">üèÖ Tes badges</h4>
{% if request.user.badges.exists %}
  <div class="d-flex flex-wrap gap-3">
    {% for badge in request.user.badges.all %}
      <div class="border rounded p-3 bg-light shadow-sm" style="min-width: 120px;">
        <div class="fs-2">{{ badge.icon }}</div>
        <strong>{{ badge.name }}</strong><br>
        <small class="text-muted">{{ badge.description }}</small>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-muted">Aucun badge pour le moment.</p>
{% endif %}

<div class="mt-3">
  <a href="{% url 'myevol:badge_list' %}" class="btn btn-outline-primary">
    Voir tous mes badges
  </a>
</div>

<noscript>
  <div class="alert alert-warning text-center">
    ‚ö†Ô∏è Ce tableau de bord utilise JavaScript pour afficher les graphiques.
    Activez-le pour en profiter pleinement.
  </div>
</noscript>

{% endblock %}
